# 📷 圖片功能故障排除指南

## 🔍 問題診斷

如果您在 Line Bot 中發送圖片但無法正常處理，請按照以下步驟進行診斷：

### 1. 檢查應用程式狀態

```bash
# 檢查應用程式是否正在運行
curl http://localhost:5000/health

# 應該看到類似回應：
{
  "image_available": true,
  "llm_available": true,
  "speech_available": true,
  "status": "healthy"
}
```

### 2. 檢查控制台輸出

當您在 Line 中發送圖片時，應用程式控制台應該顯示：

```
📷 收到圖片訊息: 用戶 [用戶ID], 訊息 ID [訊息ID]
📥 圖片下載成功: [檔案大小] bytes
✅ 圖片分析成功，回應長度: [長度] 字元
```

### 3. 常見問題及解決方案

#### 問題 1: 沒有看到圖片訊息記錄
**症狀**: 控制台沒有顯示 "📷 收到圖片訊息"
**可能原因**: 
- Line Bot Webhook URL 設定錯誤
- 網路連接問題
- Line Bot 配置問題

**解決方案**:
1. 確認 Webhook URL 設定為: `https://your-ngrok-url.ngrok.io/callback`
2. 檢查 ngrok 是否正常運行
3. 確認 Line Bot 設定中的 Channel Secret 和 Access Token 正確

#### 問題 2: 圖片下載失敗
**症狀**: 看到 "📷 收到圖片訊息" 但沒有 "📥 圖片下載成功"
**可能原因**:
- Line API 連接問題
- 暫存目錄權限問題
- 網路連接問題

**解決方案**:
1. 檢查 `.env` 檔案中的 Line 設定
2. 確認 `temp_files` 目錄存在且有寫入權限
3. 檢查網路連接

#### 問題 3: 圖片分析失敗
**症狀**: 看到 "📥 圖片下載成功" 但沒有 "✅ 圖片分析成功"
**可能原因**:
- Google API Key 問題
- LLM 服務問題
- 圖片格式問題

**解決方案**:
1. 檢查 `.env` 檔案中的 `GOOGLE_API_KEY`
2. 確認 Google Gemini API 配額充足
3. 檢查圖片格式是否支援

#### 問題 4: 分析結果為空
**症狀**: 看到 "✅ 圖片分析成功" 但回應內容為空
**可能原因**:
- LLM 無法識別圖片內容
- 圖片品質問題
- 提示詞問題

**解決方案**:
1. 確保圖片清晰，光線充足
2. 確保圖片包含真實的食材
3. 嘗試重新拍攝

### 4. 測試步驟

#### 步驟 1: 本地功能測試
```bash
# 執行本地測試
python test_image.py
python test_line_image_download.py
```

#### 步驟 2: 實際 Line 測試
1. 啟動應用程式: `python app_llm.py`
2. 啟動 ngrok: `ngrok http 5000`
3. 設定 Line Bot Webhook URL
4. 在 Line 中發送真實的冰箱食材照片

#### 步驟 3: 檢查日誌
```bash
# 查看應用程式日誌
tail -f momshero_llm.log
```

### 5. 最佳實踐

#### 拍攝技巧
- **光線充足**: 確保冰箱內有足夠的光線
- **角度適當**: 選擇能清楚看到所有食材的角度
- **避免反光**: 注意避免玻璃反光影響識別
- **食材清晰**: 確保食材輪廓清晰可見

#### 圖片要求
- **格式**: JPG, PNG, GIF, BMP, WebP
- **大小**: 最大 10MB
- **內容**: 真實的冰箱食材照片
- **品質**: 清晰、不模糊

### 6. 錯誤訊息對照

| 錯誤訊息 | 可能原因 | 解決方案 |
|---------|---------|---------|
| "抱歉，圖片處理功能目前無法使用" | 圖片處理器未初始化 | 檢查 LLM 設定 |
| "抱歉，我無法識別圖片中的食材" | LLM 無法識別 | 重新拍攝更清晰的照片 |
| "抱歉，處理您的圖片時發生錯誤" | 系統錯誤 | 檢查日誌檔案 |
| 沒有回應 | 網路連接問題 | 檢查 ngrok 和網路設定 |

### 7. 聯絡支援

如果以上步驟都無法解決問題，請提供：

1. **錯誤訊息**: 完整的錯誤訊息
2. **日誌檔案**: `momshero_llm.log` 的相關內容
3. **控制台輸出**: 應用程式啟動和圖片處理時的輸出
4. **環境資訊**: 作業系統、Python 版本等

### 8. 快速檢查清單

- [ ] 應用程式正在運行 (`python app_llm.py`)
- [ ] ngrok 正在運行並可訪問
- [ ] Line Bot Webhook URL 設定正確
- [ ] `.env` 檔案包含所有必要的金鑰
- [ ] `temp_files` 目錄存在且有寫入權限
- [ ] 網路連接正常
- [ ] 圖片是真實的食材照片
- [ ] 圖片清晰且光線充足

---

## 📞 需要協助？

如果問題仍然存在，請提供詳細的錯誤資訊，我會協助您進一步診斷和解決問題。 